function w(a){["link","go"].includes(a)&&window.scrollTo({top:0})}function l(c){let a=new URL(c||window.location.href).href;return a.endsWith("/")||a.includes(".")?a:`${a}/`}function m(a){window.history.state&&window.history.state.url===a||window.history.pushState({url:a},"internalLink",a)}function g(a){document.querySelector(a).scrollIntoView({behavior:"smooth",block:"start"})}function b(c){let a=l();return{type:"popstate",next:a}}function y(c){let a;if(c.altKey||c.ctrlKey||c.metaKey||c.shiftKey)return{type:"disqualified"};for(var d=c.target;d.parentNode;d=d.parentNode)if("A"===d.nodeName){a=d;break}if(a&&a.host!==location.host)return a.target="_blank",{type:"external"};if(a&&"cold"in(null==a?void 0:a.dataset))return{type:"disqualified"};if(!(null!=a&&a.hasAttribute("href")))return{type:"noop"};{let e=a.getAttribute("href"),h=new URL(e,location.href);if(c.preventDefault(),null!=e&&e.startsWith("#"))return g(e),{type:"scrolled"};let i=l(h.href),j=l();return{type:"link",next:i,prev:j}}}function v(a){return new DOMParser().parseFromString(a,"text/html")}function u(a){document.body.replaceWith(a.body)}function E(c){let a=a=>Array.from(a.querySelectorAll('head>:not([rel="prefetch"]')),d=a(document),e=a(c),{staleNodes:h,freshNodes:i}=k(d,e);h.forEach(a=>a.remove()),document.head.append(...i)}function k(j,n){let d=[],e=[],a=0,c=0;for(;a<j.length&&c<n.length;){let h=j[a],i=n[c];if(h.isEqualNode(i)){a++,c++;continue}let o=e.findIndex(a=>a.isEqualNode(h));if(-1!==o){e.splice(o,1),a++;continue}let q=d.findIndex(a=>a.isEqualNode(i));if(-1!==q){d.splice(q,1),c++;continue}h&&d.push(h),i&&e.push(i),a++,c++}return{staleNodes:d,freshNodes:e}}function f(){document.head.querySelectorAll("[data-reload]").forEach(p),document.body.querySelectorAll("script").forEach(p)}function p(a){let c=document.createElement("script"),d=Array.from(a.attributes);for(let{name:e,value:h}of d)c[e]=h;c.append(a.textContent),a.replaceWith(c)}let F={log:!1,pageTransitions:!1};class A{constructor(a){this.opts=a,this.enabled=!0,this.prefetched=new Set,this.opts={...F,...null!=a?a:{}},null!=window&&window.history?(document.addEventListener("click",a=>this.onClick(a)),window.addEventListener("popstate",a=>this.onPop(a)),this.prefetch()):(console.warn("flamethrower router not supported in this browser or environment"),this.enabled=!1)}go(a){let c=window.location.href,d=new URL(a,location.origin).href;return this.reconstructDOM({type:"go",next:d,prev:c})}back(){window.history.back()}forward(){window.history.forward()}get allLinks(){return Array.from(document.links).filter(a=>a.href.includes(document.location.origin)&&!a.href.includes("#")&&a.href!==(document.location.href||document.location.href+"/")&&!this.prefetched.has(a.href))}log(...a){this.opts.log&&console.log(...a)}prefetch(){if("visible"===this.opts.prefetch)this.prefetchVisible();else{if("hover"!==this.opts.prefetch)return;this.prefetchOnHover()}}prefetchOnHover(){this.allLinks.forEach(a=>{let c=a.getAttribute("href");a.addEventListener("pointerenter",()=>this.createLink(c),{once:!0})})}prefetchVisible(){"IntersectionObserver"in window&&(this.observer||(this.observer=new IntersectionObserver((a,c)=>{a.forEach(a=>{let d=a.target.getAttribute("href");if(this.prefetched.has(d)){c.unobserve(a.target);return}a.isIntersecting&&(this.createLink(d),c.unobserve(a.target))})},{root:null,rootMargin:"0px",threshold:1})),this.allLinks.forEach(a=>this.observer.observe(a)))}createLink(c){let a=document.createElement("link");a.rel="prefetch",a.href=c,a.as="document",a.onload=()=>this.log("\u{1F329}\uFE0F prefetched",c),a.onerror=a=>this.log("\u{1F915} can't prefetch",c,a),document.head.appendChild(a),this.prefetched.add(c)}onClick(a){this.reconstructDOM(y(a))}onPop(a){this.reconstructDOM(b())}async reconstructDOM({type:a,next:c,prev:h}){if(!this.enabled){this.log("router disabled");return}try{if(this.log("\u26A1",a),["popstate","link","go"].includes(a)&&c!==h){this.opts.log&&console.time("\u23F1\uFE0F"),window.dispatchEvent(new CustomEvent("flamethrower:router:fetch")),m(c);let i=await (await fetch(c,{headers:{"X-Flamethrower":"1"}})).text(),d=v(i);E(d),this.opts.pageTransitions&&document.createDocumentTransition?document.createDocumentTransition().start(()=>{u(d),f()}):(u(d),f()),w(a),window.dispatchEvent(new CustomEvent("flamethrower:router:end")),setTimeout(()=>{this.prefetch()},200),this.opts.log&&console.timeEnd("\u23F1\uFE0F")}}catch(e){return window.dispatchEvent(new CustomEvent("flamethrower:router:error",e)),this.opts.log&&console.timeEnd("\u23F1\uFE0F"),console.error("\u{1F4A5} router fetch failed",e),!1}}}let L=a=>{let c=new A(a);if(a.log&&console.log("\u{1F525} flamethrower engaged"),window){let d=window;d.flamethrower=c}return c};export{L as default}
